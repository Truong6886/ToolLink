from library import *
from ZingMP3 import *
from Spotify import *
from NhacCuaTui import *
from YouTube import *
from YTMusic import *
from AppleMusic import *
st.set_page_config(page_title="Tool l·∫•y link",page_icon="‚ñ∂Ô∏è", layout="wide")

def normalize_string(s):
    s = s.lower()
    s = re.sub(r"[^a-zA-Z0-9\s]", "", s)
    s = s.strip()
    return s
def get_channel_name(channel_input):
    """Fetch channel name based on user input (URL, @username, or Channel ID)."""
    # Handle different input formats: Channel URL, @username, or Channel ID
    if channel_input.startswith('https://www.youtube.com/channel/'):
        # If URL format, extract the channel ID
        channel_id = channel_input.split('channel/')[1]
    elif channel_input.startswith('@'):
        # If @username, we need to handle it (could use YouTube API to resolve it)
        channel_id = channel_input[1:]
    else:
        # Assume it's a Channel ID directly
        channel_id = channel_input

    # Here you would use the YouTube API or scrape the channel to fetch the name, for example:
    # This part is just an example placeholder.
    # You can use YouTube API to get the channel name using channel_id.
    channel_name = f"Channel name for {channel_id}"  # Replace with actual name resolution

    return channel_name
def search_artist_on_nhaccuatui(artist_name):
    driver = webdriver.Chrome()
    artist_page = search_artist_nhaccuatui(driver, artist_name)

    if artist_page:
        artist_song_page = artist_page.replace(".html", ".bai-hat.html")
        artist_album_page = artist_page.replace(".html", ".playlist.html")

        artist_songs = get_artist_songs(driver, artist_song_page)
        albums = get_artist_albums(driver, artist_album_page)

        all_songs = artist_songs[:]
        for album_link in albums:
            album_songs = get_album_songs(driver, album_link)
            all_songs.extend(album_songs)

        df_nct = pd.DataFrame(all_songs, columns=["album_name", "tracklist(danh s√°ch b√†i h√°t)", "Link b√†i h√°t"])
        return df_nct, "v1"
    else:
        songs, playlists = search_nhaccuatui(artist_name)
        data = []

        for song_title, song_link, _ in songs:
            data.append([song_title, song_title, song_link])

        for album_name, playlist_songs, link in playlists:
            for title, song_link in playlist_songs:
                data.append([album_name, title, song_link])

        df_nct = pd.DataFrame(data, columns=["album_name", "tracklist(danh s√°ch b√†i h√°t)", "Nhaccuatui"])
        return df_nct, "v2"

    driver.quit()

def main():
    
    st.markdown("""
        <style>
        .st-emotion-cache-18w1b6t { bottom: 65px !important; position: relative; }
        .st-emotion-cache-kj6hex { bottom: 50px !important;top: 0px; position: relative; }
        .st-emotion-cache-1wtqxho {bottom: 80px !important;}
        </style>
    """, unsafe_allow_html=True)

    with st.sidebar:
        st.image("D:\\ToolLink\\logo.png", width=1000)
        selected_platform = option_menu(
            "", ["", "ZingMP3", "Spotify", "Nhaccuatui", "AppleMusic", "YouTube", "YouTubeMusic"],
            icons=['', 'vinyl-fill', 'spotify', 'headphones', 'apple', 'youtube', 'play-circle-fill'],
            menu_icon="cast", default_index=0, orientation="vertical"
        )
        st.markdown("""<br><br><hr><p style='font-size: 12px; color: #999;'>¬© 2025 V.K Entertainment. All rights reserved.</p>""", unsafe_allow_html=True)

    if not selected_platform:
        st.write("Vui l√≤ng ch·ªçn m·ªôt n·ªÅn t·∫£ng t·ª´ thanh menu b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu.")
        return

    platforms = ["zingmp3", "spotify", "nhaccuatui", "applemusic", "youtube", "youtubemusic"]
    for platform in platforms:
        st.session_state[f"show_{platform}_input"] = (selected_platform.lower() == platform)



    if st.session_state.get("show_zingmp3_input"):
        st.subheader("T√¨m ki·∫øm b√†i h√°t tr√™n ZingMP3")

        # Th√™m m·ªôt n√∫t m·ªü ZingMP3 ƒë·ªÉ ng∆∞·ªùi d√πng t√¨m ki·∫øm ngh·ªá sƒ©
        st.markdown("[T√¨m ki·∫øm ngh·ªá sƒ© tr√™n ZingMP3](https://zingmp3.vn) ƒë·ªÉ l·∫•y M√£ ƒê·ªãnh Danh Ngh·ªá Sƒ© ho·∫∑c URL c·ªßa ngh·ªá sƒ©", unsafe_allow_html=True)

        artist_input = st.text_input("Nh·∫≠p M√£ ƒê·ªãnh Danh Ngh·ªá Sƒ© (v√≠ d·ª•: Tien-Cookie) ho·∫∑c Link ZingMP3 (v√≠ d·ª•: https://zingmp3.vn/Tien-Cookie)", key="zingmp3_input")
        
        # D√πng container ƒë·ªÉ canh chu·∫©n layout
        with st.container():
            search_clicked = st.button("T√¨m", key="zingmp3_search")

        if search_clicked:
            if artist_input.strip():
                # Ki·ªÉm tra n·∫øu ng∆∞·ªùi d√πng nh·∫≠p URL
                url_match = re.match(r"https://zingmp3.vn/([^/]+)", artist_input.strip())
                if url_match:
                    artist_input = url_match.group(1).lower()  # L·∫•y t√™n ngh·ªá sƒ© t·ª´ URL v√† chuy·ªÉn th√†nh ch·ªØ th∆∞·ªùng

                st.markdown(f"üîç ƒêang t√¨m ki·∫øm b√†i h√°t cho m√£ ƒë·ªãnh danh ngh·ªá sƒ© <strong>{artist_input}</strong> tr√™n ZingMP3...", unsafe_allow_html=True)
                df_zing = fetch_artist_songs(artist_input.strip())
                if df_zing is not None and not df_zing.empty:
                    st.success(f"‚úÖ T√¨m th·∫•y {len(df_zing)} b√†i h√°t.")
                    # B·∫£ng hi·ªÉn th·ªã
                    st.dataframe(df_zing, use_container_width=True)
                    st.markdown("###")
                    output_file = f"{artist_input}_zingmp3.xlsx"
                    df_zing.to_excel(output_file, index=False)
                    with open(output_file, "rb") as f:
                        st.download_button(
                            "üì• T·∫£i k·∫øt qu·∫£ v·ªÅ (.xlsx)", 
                            f, 
                            output_file, 
                            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                        )
                else:
                    st.warning("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y b√†i h√°t n√†o.")
            else:
                st.error("Vui l√≤ng nh·∫≠p t√™n ngh·ªá sƒ© ho·∫∑c URL ZingMP3.")


    # N·∫øu ch·ªçn Spotify
    if st.session_state.get("show_spotify_input", False):
        st.subheader("T√¨m ki·∫øm b√†i h√°t tr√™n Spotify")
        spotify_input = st.text_input("Nh·∫≠p T√™n Ngh·ªá Sƒ© (v√≠ d·ª•: Ti√™n Cookies)", key="spotify_input")
        if st.button("T√¨m", key="spotify_search"):
            keyword = spotify_input.strip()
            if keyword:
                st.markdown(f"üîç ƒêang t√¨m ki·∫øm b√†i h√°t cho ngh·ªá sƒ© **{keyword}** tr√™n Spotify...")
                df_spotify = get_artist_tracks_all(keyword)
                df_spotify['distribute'] = df_spotify['distribute'].apply(extract_licensing_provider)

                df_spotify['normalized_album_name'] = df_spotify['album_name'].apply(normalize_string)
                df_spotify.sort_values(by=["normalized_album_name"], ascending=True, inplace=True)
                df_spotify.drop(columns=["normalized_album_name"], inplace=True)
                df_spotify.reset_index(drop=True, inplace=True)
                if df_spotify is not None and not df_spotify.empty:
                    st.success(f"‚úÖ T√¨m th·∫•y {len(df_spotify)} b√†i h√°t.")
                    st.dataframe(df_spotify, use_container_width=True)
                    st.markdown("###")
                    output_file = f"{keyword}_spotify.xlsx"
                    df_spotify.to_excel(output_file, index=False)

                    with open(output_file, "rb") as f:
                        st.download_button(
                            label="üì• T·∫£i k·∫øt qu·∫£ v·ªÅ (.xlsx)",
                            data=f,
                            file_name=output_file,
                            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                        )
                else:
                    st.warning("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y b√†i h√°t n√†o.")
            else:
                st.error("Vui l√≤ng nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm.") 

    # N·∫øu ch·ªçn Nhaccuatui
    if st.session_state.get("show_nhaccuatui_input", False):
        st.subheader("T√¨m ki·∫øm b√†i h√°t tr√™n Nhaccuatui")
        nct_artist_input = st.text_input("Nh·∫≠p T√™n Ngh·ªá Sƒ© (v√≠ d·ª•: Ti√™n Cookies)", key="nct_input")
        
        if st.button("T√¨m", key="nct_search"):
            nct_artist_name = nct_artist_input.strip()
            
            if nct_artist_name:
                st.markdown(f"üîç ƒêang t√¨m ki·∫øm b√†i h√°t cho ngh·ªá sƒ© **{nct_artist_name}** tr√™n Nhaccuatui...")
                try:
                    df_nct, method = search_artist_on_nhaccuatui(nct_artist_name)
                    st.markdown(f"ƒê√£ t√¨m th·∫•y b√†i h√°t cho ngh·ªá sƒ©    **{nct_artist_name}** b·∫±ng ph∆∞∆°ng ph√°p {method}")

                    # Hi·ªÉn th·ªã b·∫£ng d·ªØ li·ªáu
                    st.dataframe(df_nct, use_container_width=True)
                    st.markdown("###")
                    # Chu·∫©n b·ªã buffer v√† th√™m n√∫t t·∫£i file ngay d∆∞·ªõi b·∫£ng
                    buffer = io.BytesIO()
                    df_nct.to_excel(buffer, index=False, engine='openpyxl')
                    buffer.seek(0)

                    st.download_button(
                        label="üì• T·∫£i k·∫øt qu·∫£ v·ªÅ (.xlsx)",
                        data=buffer,
                        file_name=f"{nct_artist_name}_NhacCuaTui_{method}.xlsx",
                        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                    )

                except Exception as e:
                    st.error(f"L·ªói khi t√¨m ki·∫øm ngh·ªá sƒ©: {e}")
            else:
                st.error("Vui l√≤ng nh·∫≠p t√™n ngh·ªá sƒ©.") 

    if st.session_state.get("show_applemusic_input"):
        st.subheader("T√¨m ki·∫øm b√†i h√°t tr√™n Apple Music")

        # √î nh·∫≠p ID ngh·ªá sƒ©
        artist_id = st.text_input("Nh·∫≠p M√£ ƒê·ªãnh Danh Ngh·ªá Sƒ© (V√≠ d·ª•: 1297259948):", value="")

        if st.button("T√¨m ki·∫øm") and artist_id.strip():
            with st.spinner("ƒêang l·∫•y d·ªØ li·ªáu t·ª´ Apple Music..."):
                try:
                    df_tracks, artist_name = get_artist_tracks_dataframe(artist_id)
                    artist_name = artist_name.replace("_", " ")
                    st.success(f"ƒê√£ l·∫•y ƒë∆∞·ª£c {len(df_tracks)} b√†i h√°t cho ngh·ªá sƒ© `{artist_name}`")

                    # Hi·ªÉn th·ªã b·∫£ng d·ªØ li·ªáu
                    st.dataframe(df_tracks, use_container_width=True)

                    # N√∫t t·∫£i v·ªÅ
                    def convert_df(df):
                        output = BytesIO()
                        with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
                            df.to_excel(writer, index=False, sheet_name="Tracks")
                        return output.getvalue()

                    excel_data = convert_df(df_tracks)
                    st.download_button(
                        label="üì• T·∫£i v·ªÅ Excel",
                        data=excel_data,
                        file_name=f"{artist_name}_song_Apple.xlsx",
                        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                    )

                except Exception as e:
                    st.error(f"L·ªói khi l·∫•y d·ªØ li·ªáu: {str(e)}")
    if st.session_state.get("show_youtube_input"):
        st.subheader("T√¨m ki·∫øm video t·ª´ k√™nh YouTube")

        user_input = st.text_input("Nh·∫≠p @username, ƒë∆∞·ªùng d·∫´n ho·∫∑c Channel ID:", key="channel_input")

        if st.button("T√¨m"):
            user_input = user_input.strip()

            if user_input:
                st.info(f"üé¨ ƒêang t√¨m video t·ª´: **{user_input}**")
                
                # Get the actual channel name or ID
                channel_name = get_channel_name(user_input)
                st.info(f"üì∫ K√™nh: {channel_name}")

                # Now, fetch the videos using the extracted channel ID or username
                df = get_channel_videos(user_input)  # Assuming get_channel_videos works with user_input

                if not df.empty:
                    st.success(f"‚úÖ T√¨m th·∫•y {len(df)} video.")
                    st.dataframe(df, use_container_width=True)
                    st.markdown("###")

                    # T·∫°o buffer Excel ƒë·ªÉ t·∫£i
                    buffer = io.BytesIO()
                    df.to_excel(buffer, index=False, engine="openpyxl")
                    buffer.seek(0)

                    st.download_button(
                        label="üì• T·∫£i v·ªÅ danh s√°ch video (.xlsx)",
                        data=buffer,
                        file_name=f"{user_input.replace('@','').replace('/','_')}_videos.xlsx",
                        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                    )
                else:
                        st.warning("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y video n√†o.")
            else:
                    st.error("‚ö†Ô∏è Vui l√≤ng nh·∫≠p d·ªØ li·ªáu.")
    if st.session_state.get("show_youtubemusic_input"):
        st.subheader("T√¨m ki·∫øm nh·∫°c t·ª´ k√™nh YouTube Music")
        channel_music_url = st.text_input("Nh·∫≠p link ho·∫∑c Channel ID c·ªßa k√™nh YouTube Music:", key="ytmusic_input")

        if st.button("T√¨m"):
            channel_music_url = channel_music_url.strip()
            if channel_music_url:
                if channel_music_url.startswith("http"):
                    st.info(f"üîç ƒêang t√¨m ki·∫øm b√†i h√°t t·ª´ **link**: {channel_music_url}")
                else:
                    st.info(f"üîç ƒêang t√¨m ki·∫øm b√†i h√°t t·ª´ **Channel ID**: {channel_music_url}")

                try:
                    # Scrape the YouTube music data
                    df, artist_name = scrape_youtube_music(channel_music_url)

                    if not df.empty:
                        st.success(f"‚úÖ T√¨m th·∫•y {len(df)} b√†i h√°t.")
                        st.dataframe(df, use_container_width=True)
                        st.markdown("###")

                        # Create the download button with the correct artist name in the file
                        buffer = io.BytesIO()
                        df.to_excel(buffer, index=False, engine="openpyxl")
                        buffer.seek(0)

                        # Sanitize artist name to avoid file name issues
                        artist_name = artist_name if artist_name != "unknown_artist" else "artist"
                        sanitized_artist_name = re.sub(r'[\\/*?:"<>|]', "_", artist_name)

                        st.download_button(
                            label="üì• T·∫£i danh s√°ch b√†i h√°t (.xlsx)",
                            data=buffer,
                            file_name=f"{sanitized_artist_name}_youtube_music_tracks.xlsx",
                            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                        )
                except Exception as e:
                    st.error(f"‚ùå L·ªói x·∫£y ra: {e}")
            else:
                    st.error("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë∆∞·ªùng d·∫´n k√™nh YouTube Music.")
        

if __name__ == "__main__":
    main()
